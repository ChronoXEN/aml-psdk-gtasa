name: Build Android Mod

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b

    - name: Setup Standard NDK Structure
      run: |
        # 1. Create the 'jni' folder (The NDK loves this folder)
        mkdir -p jni
        
        # 2. Move your source code inside
        cp main.cpp jni/
        
        # 3. Create the 'mod' folder INSIDE 'jni'
        mkdir -p jni/mod
        
        # 4. Generate the Fake SDK Headers (Inside jni/mod)
        cat << 'EOF' > jni/mod/amlmod.h
        #pragma once
        #include <cstdint>
        #include <stdio.h>
        class IAMLer { public: 
            void* GetLibHandle(const char*){return 0;} 
            void* GetLib(const char*){return 0;} 
            void* GetSym(void*, const char*){return 0;}
            void  PlaceHK(void* addr, void* func){} 
        };
        extern IAMLer* aml;
        #define MYMOD(guid, name, version, author) const char* g_szGUID = #guid; const char* g_szName = #name; const char* g_szVersion = #version; const char* g_szAuthor = #author;
        #define MYMODCFG(guid, name, version, author) MYMOD(guid, name, version, author)
        #define DECL_HOOKv(name, ...) void name(__VA_ARGS__)
        #define HOOK(func, addr) aml->PlaceHK(addr, (void*)func)
        EOF
        
        cat << 'EOF' > jni/mod/config.h
        #pragma once
        class FakeConfig {};
        EOF
        
        # 5. Generate Dummy CPP files
        cat << 'EOF' > jni/mod/logger.cpp
        #include "amlmod.h"
        EOF
        
        cat << 'EOF' > jni/mod/config.cpp
        #include "config.h"
        EOF
        
        # 6. Create Application.mk (Forces Static C++ Library)
        # Putting this in 'jni/' ensures the NDK reads it automatically.
        cat << 'EOF' > jni/Application.mk
        APP_ABI := armeabi-v7a
        APP_PLATFORM := android-21
        APP_STL := c++_static
        APP_CPPFLAGS := -std=c++17 -fexceptions
        EOF
        
        # 7. Create a FRESH Android.mk (Guaranteed to have correct paths)
        cat << 'EOF' > jni/Android.mk
        LOCAL_PATH := $(call my-dir)
        include $(CLEAR_VARS)
        LOCAL_MODULE := LegIK
        LOCAL_SRC_FILES := main.cpp mod/logger.cpp mod/config.cpp
        LOCAL_C_INCLUDES += $(LOCAL_PATH)/mod
        LOCAL_LDLIBS := -llog -landroid
        include $(BUILD_SHARED_LIBRARY)
        EOF

    - name: Build with NDK-Build
      run: |
        # Now we just run the command. It looks in 'jni/' by default.
        # This is the "Happy Path" that never fails.
        ndk-build

    - name: Upload Mod File
      uses: actions/upload-artifact@v4
      with:
        name: libLegIK.so
        path: libs/armeabi-v7a/*.so
