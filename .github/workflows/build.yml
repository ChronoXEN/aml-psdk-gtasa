name: Build Android Mod

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25b

    - name: Generate Missing SDK Files
      run: |
        mkdir -p mod
        
        # 1. AMLMOD.H (THE FIX IS HERE)
        cat << 'EOF' > mod/amlmod.h
        #pragma once
        #include <cstdint>
        #include <stdio.h>
        
        class IAMLer { public: 
            void* GetLibHandle(const char*){return 0;} 
            void* GetLib(const char*){return 0;} 
            void* GetSym(void*, const char*){return 0;}
            void  PlaceHK(void* addr, void* func){} 
        };
        extern IAMLer* aml;
        
        // FIX: Force these variables to be EXTERN and VISIBLE so AML can find them
        #define MYMOD(guid, name, version, author) \
            extern "C" { \
                __attribute__((visibility("default"))) const char* g_szGUID = #guid; \
                __attribute__((visibility("default"))) const char* g_szName = #name; \
                __attribute__((visibility("default"))) const char* g_szVersion = #version; \
                __attribute__((visibility("default"))) const char* g_szAuthor = #author; \
            }
            
        #define MYMODCFG(guid, name, version, author) MYMOD(guid, name, version, author)
        #define DECL_HOOKv(name, ...) void name(__VA_ARGS__)
        #define HOOK(func, addr) aml->PlaceHK(addr, (void*)func)
        EOF
        
        # 2. LOGGER.H
        cat << 'EOF' > mod/logger.h
        #pragma once
        class FakeLogger { public: void SetTag(const char*){} void Info(const char* ...){} };
        extern FakeLogger* logger;
        EOF
        
        # 3. CONFIG.H
        cat << 'EOF' > mod/config.h
        #pragma once
        class FakeConfig {};
        EOF
        
        # 4. CPP FILES
        cat << 'EOF' > mod/logger.cpp
        #include "logger.h"
        FakeLogger* logger = nullptr;
        EOF
        
        cat << 'EOF' > mod/config.cpp
        #include "config.h"
        EOF

    - name: Build with NDK-Build (STATIC + VISIBLE)
      run: |
        ndk-build \
          NDK_PROJECT_PATH=. \
          APP_BUILD_SCRIPT=./Android.mk \
          APP_PLATFORM=android-21 \
          APP_ABI=armeabi-v7a \
          APP_STL=c++_static \
          LOCAL_C_INCLUDES+=. \
          LOCAL_CFLAGS+="-fvisibility=default"

    - name: Upload Mod File
      uses: actions/upload-artifact@v4
      with:
        name: libLegIK.so
        path: libs/armeabi-v7a/*.so
